version: 1

defaults:
  region: ap-northeast-1

targets:
  profiles: [
    # "COM_PRD"
  ] # 空なら ~/.aws/config から自動取得
  exclude:
    - SAMPLE_PROFILE

vars: # build-in var: PROFILE,REGION,ACCOUNT_ID
  defaults:
    ## s3-bucket 
    BUCKET_NAME: s3-${SYSTEM}-${ENV}-necro-artifact
    ## s3-file
    CFN_LOCAL: conf/cfn_stack-SYSTEM-ENV-necro.yml
    CFN_REMOTE: stack-${SYSTEM}-${ENV}-necro.yml
    ## cfn-stack
    TEMPLATE_URL: https://${BUCKET_NAME}.s3.${REGION}.amazonaws.com/${CFN_REMOTE}
    STACK_NAME: stack-${SYSTEM}-${ENV}-necro
    ROLE_NAME: role-${SYSTEM}-${ENV}-necro-assume-role
    CHANGE_SET_NAME: cs-${RUN_ID}
    TRUSTED_ACCOUNT_ID: "123456789012"

  profiles:
    COM_PRD:
      SYSTEM: com
      ENV: prd

cmd:
  ## 内部で自動実行
  # - name: check-sts
  #   aws: ["sts", "get-caller-identity"]


  ## Organizationsアカウント(一覧)
  # - name: organizations_list-accounts
  #   aws: ["organizations", "list-accounts"]
  #   out: "./out/${SYSTEM}_org-accounts.json"
  ## Organizationsアカウント一覧->スクリプト加工
  # - name: org-account-list-slim
  #   sh: "jq '.Accounts | map({Id: .Id, Name: .Name})'"
  #   in: "./out/${SYSTEM}_org-accounts.json"
  #   out: "./out/${SYSTEM}_org-account-list.json"


  ## S3バケット(一覧)
  # - name: s3-bucket-list
  #   aws: ["s3api", "list-buckets"]

  ## S3バケット(作成)
  # - name: s3-bucket-create
  #   aws:
  #     [
  #       "s3api",
  #       "create-bucket",
  #       "--bucket",
  #       "${BUCKET_NAME}",
  #       "--create-bucket-configuration",
  #       "LocationConstraint=${REGION}",
  #     ]

  ## S3バケット(確認)
  # - name: s3-bucket-check
  #   aws:
  #     [
  #       "s3api",
  #       "head-bucket",
  #       "--bucket",
  #       "${BUCKET_NAME}",
  #     ]


  ## S3オブジェクト(DELETE)
  # - name: s3-delete-object
  #   aws:
  #     [
  #       "s3api",
  #       "delete-object",
  #       "--bucket",
  #       "${BUCKET_NAME}",
  #       "--key",
  #       "${CFN_REMOTE}",
  #     ]

  ## S3オブジェクト(PUT)
  # - name: s3-cp
  #   aws:
  #     [
  #       "s3",
  #       "cp",
  #       "${CFN_LOCAL}",
  #       "s3://${BUCKET_NAME}/${CFN_REMOTE}",
  #     ]


  ## CFNスタック(削除)
  # - name: stack-delete
  #   aws:
  #     [
  #       "cloudformation",
  #       "delete-stack",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #     ]
  # - name: stack-wait-delete
  #   aws:
  #     [
  #       "cloudformation",
  #       "wait",
  #       "stack-delete-complete",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #     ]

  ## CFNスタック(作成)
  # - name: stack-deploy
  #   aws:
  #     [
  #       "cloudformation",
  #       "deploy",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #       "--template-file",
  #       "${CFN_LOCAL}",
  #       "--capabilities",
  #       "CAPABILITY_NAMED_IAM",
  #       "--parameter-overrides",
  #       "RoleName=${ROLE_NAME}",
  #       "BucketName=${BUCKET_NAME}",
  #       "TrustedAccountId=${TRUSTED_ACCOUNT_ID}"
  #     ]

  ## CFNスタック.変更セット(全削除)
  # - name: changeset-list
  #   aws:
  #     ["cloudformation","list-change-sets","--stack-name","${STACK_NAME}"]
  #   capture:
  #     CHANGE_SET_NAMES: "Summaries[].ChangeSetName"

  # - name: changeset-delete-all
  #   foreach:
  #     var: CHANGE_SET_NAMES
  #     as: CHANGE_SET_NAME
  #   aws:
  #     [
  #       "cloudformation",
  #       "delete-change-set",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #       "--change-set-name",
  #       "${CHANGE_SET_NAME}"
  #     ]

  ## CFNスタック(更新※差分なし変更セット自動削除)
  # - name: stack-update-changeset-create
  #   aws:
  #     [
  #       "cloudformation",
  #       "create-change-set",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #       "--change-set-name",
  #       "${CHANGE_SET_NAME}",
  #       "--change-set-type",
  #       "UPDATE",
  #       "--template-body",
  #       "file://${CFN_LOCAL}",
  #       "--capabilities",
  #       "CAPABILITY_NAMED_IAM",
  #       "--parameters",
  #       "ParameterKey=RoleName,ParameterValue=${ROLE_NAME}",
  #       "ParameterKey=BucketName,ParameterValue=${BUCKET_NAME}",
  #       "ParameterKey=TrustedAccountId,ParameterValue=${TRUSTED_ACCOUNT_ID}"
  #     ]
  #   capture:
  #     CHANGE_SET_ID: "Id"
  # - name: stack-update-changeset-wait
  #   aws:
  #     [
  #       "cloudformation",
  #       "wait",
  #       "change-set-create-complete",
  #       "--change-set-name",
  #       "${CHANGE_SET_ID}"
  #     ]
  # - name: stack-update-changeset-describe
  #   aws:
  #     [
  #       "cloudformation",
  #       "describe-change-set",
  #       "--change-set-name",
  #       "${CHANGE_SET_ID}"
  #     ]
  #   if:
  #     expr: "Status"
  #     op: "eq"
  #     value: "FAILED"
  #   ok:
  #     - name: stack-update-changeset-delete-empty
  #       aws:
  #         [
  #           "cloudformation",
  #           "delete-change-set",
  #           "--change-set-name",
  #           "${CHANGE_SET_ID}"
  #         ]
  #   ng:
  #     - name: stack-update-changeset-exec
  #       aws:
  #         [
  #           "cloudformation",
  #           "execute-change-set",
  #           "--change-set-name",
  #           "${CHANGE_SET_ID}"
  #         ]
  #     - name: stack-update-wait
  #       aws:
  #         [
  #           "cloudformation",
  #           "wait",
  #           "stack-update-complete",
  #           "--stack-name",
  #           "${STACK_NAME}"
  #         ]