version: 1

defaults:
  region: ap-northeast-1

targets:
  profiles: [
    "COM_PRD"
  ] # 空なら ~/.aws/config から自動取得
  exclude:
    - SAMPLE_PROFILE

vars: # build-in var: PROFILE, REGION, ACCOUNT_ID, RUN_ID
  template-resolve-limit: 10

  defaults:
    SYSTEM: '{{ (splitList "_" .PROFILE | first | lower) }}'
    ENV: '{{ (splitList "_" .PROFILE | last | lower) }}'

  # profiles:
  #   COM_PRD:
  #     SYSTEM: com
  #     ENV: prd

cmd:
  ## Organizationsアカウント(一覧)
  - name: organizations_list-accounts
    aws: ["organizations", "list-accounts"]
    out: "./out/org-accounts.json"
  ## Organizationsアカウント一覧->スクリプト加工
  - name: org-account-list-slim
    sh: >
      jq '
        .Accounts
        | map(
            .Name as $name
            | ($name | split("_")) as $p
            | {
                Id: .Id,
                Name: $name,
                System: ($p[0] | ascii_downcase),
                Env: ($p[1] | ascii_downcase)
              }
          )
      '
    in: "./out/org-accounts.json"
    out: "./out/org-account-list.json"
  ## Organizationsアカウント一覧(JSON) -> aws_config.txt生成
  - name: org-account-list-to-aws-config
    sh: >
      jq -r '
        .[] |
        .Name as $name |
        ($name | split("_")) as $parts |
        ($parts[0] | ascii_downcase) as $system |
        ($parts[1] | ascii_downcase) as $env |
        "[profile \($name)]",
        "region = ap-northeast-1",
        "sso_account_id = \(.Id)",
        "sso_session = AWS_SESSION",
        "sso_role_name = ps-org-admin-for-\($system)-\($env)",
        ""
      '
    in: "./out/org-account-list.json"
    out: "./out/aws_config.txt"
