version: 1

defaults:
  region: ap-northeast-1

targets:
  profiles: [] # 空なら ~/.aws/config から自動取得
  exclude:
    - SAMPLE_PROFILE

vars:
  defaults:
    BUCKET_NAME: s3-${SYSTEM}-${ENV}-necro-artifact

    TEMPLATE_FILE: conf/task3_cfn_necro-assume-role.yml
    TEMPLATE_S3_KEY: necro-assume-role.yml

    STACK_NAME: stack-${SYSTEM}-${ENV}-necro
    ROLE_NAME: role-${SYSTEM}-${ENV}-necro-assume-role

  profiles:
    XXX_PRD:
      SYSTEM: xxx
      ENV: prd

cmd:
  - name: necro-artifact-s3bucket-check
    run: ["s3api", "head-bucket", "--bucket", "${BUCKET_NAME}"]

  ## テンプレートアップロード
  - name: necro-assume-role-template-upload
    run:
      [
        "s3",
        "cp",
        "${TEMPLATE_FILE}",
        "s3://${BUCKET_NAME}/${TEMPLATE_S3_KEY}",
      ]

  ## 作成/更新
  - name: necro-assume-role-stack-deploy
    run:
      [
        "cloudformation",
        "deploy",
        "--stack-name",
        "${STACK_NAME}",
        "--template-file",
        "${TEMPLATE_FILE}",
        "--capabilities",
        "CAPABILITY_NAMED_IAM",
        "--parameter-overrides",
        "RoleName=${ROLE_NAME}",
        "BucketName=${BUCKET_NAME}"
      ]

  ## 削除
  # - name: necro-assume-role-stack-delete
  #   run:
  #     [
  #       "cloudformation",
  #       "delete-stack",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #     ]

  # - name: necro-assume-role-stack-wait-delete
  #   run:
  #     [
  #       "cloudformation",
  #       "wait",
  #       "stack-delete-complete",
  #       "--stack-name",
  #       "${STACK_NAME}",
  #     ]